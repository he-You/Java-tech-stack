### Zookeeper学习（概念篇）

#### 一、概述

- **ZooKeeper  本身就是一个分布式程序（只要半数以上节点存活，ZooKeeper  就能正常服务）。**

- **为了保证高可用，最好是以集群形态来部署 ZooKeeper，这样只要集群中大部分机器是可用的（能够容忍一定的机器故障），那么 ZooKeeper 本身仍然是可用的。**

- **ZooKeeper  将数据保存在内存中，这也就保证了 高吞吐量和低延迟**（但是内存限制了能够存储的容量不太大，此限制也是保持znode中存储的数据量较小的进一步原因）。

- **ZooKeeper 是高性能的。 在“读”多于“写”的应用程序中尤其地高性能，因为“写”会导致所有的服务器间同步状态。**（“读”多于“写”是协调服务的典型场景。）

- **ZooKeeper有临时节点的概念。 当创建临时节点的客户端会话一直保持活动，瞬时节点就一直存在。而当会话终结时，瞬时节点被删除。持久节点是指一旦这个ZNode被创建了，除非主动进行ZNode的移除操作，否则这个ZNode将一直保存在Zookeeper上。**

- ZooKeeper 底层其实只提供了两个功能：①管理（存储、读取）用户程序提交的数据；②为用户程序提交数据节点监听服务。



#### 二、会话（session）

session是指Zookeeper服务器与客户端的会话。也就是一个客户端与服务器的**一个TCP长连接**。当客户端第一次与服务器建立连接，session的生命周期也就开始了。在此生命周期中，客户端可以通过心跳检查与服务器保持有效的session会话，并发送请求与进行响应，以及接受服务器的Watch事件通知。

创建会话之前，服务器为每台客户端分配一个sessionID,作为客户端与服务器重要标识，**这个sessionID全局唯一**

其中会话的过期时间sessionTimeout的值用来设置客户端的超时时间，当服务器压力过大或者出现故障而断开连接，**只要在这个sessionTimeout时间之内能够重新连接集群中的任意一台服务器，那么之前的session依然有效**。



#### 三、ZNode

在Zookeeper集群服务中有两种节点：机器节点和数据节点。前者为构成集群的机器，后者为数据存储单元也就是Znode。

Zookeeper具有文件（树）系统的特点，其数据存在于内存中，路径用过”/“进行分割。

其中ZNode根据时效性又分为：持久节点与临时节点

- 持久节点：一旦被创建，除非进行手动的移除操作，否则该类节点会一直保存在zookeeper中。
- 临时节点：创建与失效与会话的时效性一致，当客户端会话失效，该类节点也就随之失效并移除。

另外：

ZooKeeper还允许用户为每个节点添加一个特殊的属性：**SEQUENTIAL**.一旦节点被标记上这个属性，那么在这个节点被创建的时候，Zookeeper会自动在其节点名后面追加上一个整型数字，这个整型数字是一个由父节点维护的自增数字。



#### 四、版本

ZNode作为存储数据的单元，Zookeeper会通过Stat来维护3个版本信息：

- version: 当前ZNode的版本
- cversion:当前ZNode子节点的版本
- cversion:当前ZNode的ACL版本



#### 五、事件监听器Watcher

Zookeeper允许用户在指定节点注册一些Watcher,并在特点事件触发时，Zookeeper将事件通知到特定的客户端上，该机制是Zookeeper实现分布式协调服务的重要特性



#### 六、ACL

ACL（Access-Control-Lists）作为Zookeeper的权限控制策略，类似UNIX的文件系统权限控制，该策略定义了以下五种权限：

- CREATE:创建子节点的权限
- READ:获取节点数据与子节点列表的权限
- WRITE:更新节点数据的权限
- DELETE:删除子节点的权限
- ADMIN:设置节点ACL的权限



#### 七、ZAB协议与Paxos算法

##### 1. ZAB协议（**ZooKeeper Atomic Broadcast 原子广播**）

该协议是为分布式协调服务 ZooKeeper 专门设计的一种支持崩溃恢复的原子广播协议。 在 ZooKeeper 中，主要依赖 ZAB 协议来实现分布式数据一致性，基于该协议，ZooKeeper 实现了一种主备模式的系统架构来保持集群中各个副本之间的数据一致性。



ZAB协议的两种基本模式：

- 崩溃恢复：整个服务框架在启动过程中，或是当 Leader 服务器出现网络中断、崩溃退出与重启等异常情况时，ZAB 协议就会进人恢复模式并选举产生新的Leader服务器。当选举产生了新的 Leader 服务器，同时集群中已经有过半的机器与该Leader服务器完成了状态同步之后，ZAB协议就会退出恢复模式。其中，**所谓的状态同步是指数据同步，用来保证集群中存在过半的机器能够和Leader服务器的数据状态保持一致**。
- 消息广播：**当集群中已经有过半的Follower服务器完成了和Leader服务器的状态同步，那么整个服务框架就可以进人消息广播模式了。** 当一台同样遵守ZAB协议的服务器启动后加入到集群中时，如果此时集群中已经存在一个Leader服务器在负责进行消息广播，那么新加入的服务器就会自觉地进人数据恢复模式：找到Leader所在的服务器，并与其进行数据同步，然后一起参与到消息广播流程中去。ZooKeeper设计成只允许唯一的一个Leader服务器来进行事务请求的处理。Leader服务器在接收到客户端的事务请求后，会生成对应的事务提案并发起一轮广播协议；而如果集群中的其他机器接收到客户端的事务请求，那么这些非Leader服务器会首先将这个事务请求转发给Leader服务器。



##### 2.Paxos算法

Paxos算法是基于**消息传递**且具有**高度容错特性**的**一致性算法**，是目前公认的解决**分布式一致性**问题**最有效**的算法之一